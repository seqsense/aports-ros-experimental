# Contributor: Bradley J Chambers <brad.chambers@gmail.com>
# Maintainer: Bradley J Chambers <brad.chambers@gmail.com>
pkgname=pcl
pkgver=1.10.1
pkgrel=2
pkgdesc="Point Cloud Library (PCL)"
url="https://github.com/PointCloudLibrary/pcl"
arch="all !x86 !s390x" # tests fails on x86 and s390x
license="BSD-3-Clause"
depends_dev="eigen-dev boost-dev flann-dev qhull-dev<8.0.0 vtk8-dev"
makedepends="cmake eigen-dev boost-dev flann-dev qhull-dev<8.0.0 vtk8-dev"
subpackages="$pkgname-dev $pkgname-doc"
_gtestver=1.8.0
source="$pkgname-$pkgver.tar.gz::https://github.com/PointCloudLibrary/$pkgname/archive/$pkgname-$pkgver.tar.gz
  release-$_gtestver.tar.gz::https://github.com/google/googletest/archive/release-$_gtestver.tar.gz
  fix-fcntl-path.patch"
builddir="$srcdir/$pkgname-$pkgname-$pkgver"

build() {
  cd "$builddir"

  mkdir build && cd build

	local disable_segtests=
	case "$CARCH" in
		ppc64le | aarch64) disable_segtests="-DBUILD_tests_segmentation=OFF"
	esac
	# Five tests are disabled below. This is in keeping with PCL's own
	# Appveyor configuration
	# (https://github.com/PointCloudLibrary/pcl/blob/master/.appveyor.yml),
	# and is due to a list of test failures that are documented in issues
	# #1702, #1719, #1921, and #2136.
  cmake .. \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_BUILD_TYPE=Release \
    -DHAVE_SSE3_EXTENSIONS=1 \
    -DHAVE_MM_MALLOC=1 \
    -DCMAKE_CXX_FLAGS="$CFLAGS -march=x86-64 -msse3 -mfpmath=sse" \
    -DWITH_CUDA=OFF \
    -DWITH_DAVIDSDK=OFF \
    -DWITH_DSSDK=OFF \
    -DWITH_ENSENSO=OFF \
    -DWITH_FZAPI=OFF \
    -DWITH_LIBUSB=OFF \
    -DWITH_OPENGL=OFF \
    -DWITH_OPENNI=OFF \
    -DWITH_OPENNI2=OFF \
    -DWITH_PCAP=OFF \
    -DWITH_PNG=OFF \
    -DWITH_QHULL=ON \
    -DWITH_QT=OFF \
    -DWITH_VTK=ON \
    -DBUILD_global_tests=ON \
    -DBUILD_examples=OFF \
    -DBUILD_tools=ON \
    -DBUILD_apps=OFF \
    -DBUILD_tests_common=OFF \
    -DBUILD_tests_features=OFF \
    -DBUILD_tests_filters=OFF \
    -DBUILD_tests_io=OFF \
		$disable_segtests \
    -DBUILD_tests_registration=OFF \
    -DGTEST_SRC_DIR=$srcdir/googletest-release-$_gtestver/googletest \
    -DGTEST_INCLUDE_DIR=$srcdir/googletest-release-$_gtestver/googletest/include
  make
}

package() {
  cd "$builddir"/build
  make DESTDIR="$pkgdir" install

  install -Dm 0644 "$builddir"/LICENSE.txt "$pkgdir"/usr/share/licenses/$pkgname/LICENSE.txt
}

check() {
  cd "$builddir"/build
  make tests
}

sha512sums="abb0acef3c6f49da02684200531cef8080baa67d9b94c30edc0d5244294a531e41c14b46b378bd927829de0e3921fec04fd389afe9db45cdd78a262c095a6a9f  pcl-1.10.1.tar.gz
1dbece324473e53a83a60601b02c92c089f5d314761351974e097b2cf4d24af4296f9eb8653b6b03b1e363d9c5f793897acae1f0c7ac40149216035c4d395d9d  release-1.8.0.tar.gz
83a5a5adc066a15c5db0fa0bf45cc57d606603cce3e5f27dcf5899cd12282ec2e9f5322f807734f1e998c1e2f4b28e40dc60dd65a6bee0ed341874ebdf2f1223  fix-fcntl-path.patch"
