# Contributor: Bradley J Chambers <brad.chambers@gmail.com>
# Maintainer: Bradley J Chambers <brad.chambers@gmail.com>
pkgname=pcl
pkgver=1.15.1
pkgrel=4
pkgdesc="Point Cloud Library (PCL)"
url="https://github.com/PointCloudLibrary/pcl"
arch="all !x86 !s390x" # tests fails on x86 and s390x
license="BSD-3-Clause"
depends_dev="
	boost-dev
	cjson-dev
	cjson-static
	eigen-dev
	flann-dev
	lz4-dev
	qhull-dev
	qhull-static
	vtk-dev
	"
makedepends="
	$depends_dev
	cmake
	gtest
	gtest-dev
	gtest-src
	"
subpackages="$pkgname-doc $pkgname-dev $pkgname-libs"
_gtestver=1.8.0
source="$pkgname-$pkgver.tar.gz::https://github.com/PointCloudLibrary/$pkgname/archive/$pkgname-$pkgver.tar.gz
	fix-infinite-loop-in-convex-hull.patch
	"
builddir="$srcdir/$pkgname-$pkgname-$pkgver"

build() {
	cd "$builddir"

	mkdir build && cd build

	local disable_segtests=
	case "$CARCH" in
		ppc64le | aarch64) disable_segtests="-DBUILD_tests_segmentation=OFF"
	esac
	# Five tests are disabled below. This is in keeping with PCL's own
	# Appveyor configuration
	# (https://github.com/PointCloudLibrary/pcl/blob/master/.appveyor.yml),
	# and is due to a list of test failures that are documented in issues
	# #1702, #1719, #1921, and #2136.
	cmake .. \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_BUILD_TYPE=None \
		-DHAVE_SSE3_EXTENSIONS=1 \
		-DHAVE_MM_MALLOC=1 \
		-DCMAKE_CXX_FLAGS="$CFLAGS -march=x86-64 -msse3 -mfpmath=sse" \
		-DWITH_CUDA=OFF \
		-DWITH_DAVIDSDK=OFF \
		-DWITH_DSSDK=OFF \
		-DWITH_ENSENSO=OFF \
		-DWITH_FZAPI=OFF \
		-DWITH_LIBUSB=OFF \
		-DWITH_OPENGL=OFF \
		-DWITH_OPENNI=OFF \
		-DWITH_OPENNI2=OFF \
		-DWITH_PCAP=OFF \
		-DWITH_PNG=OFF \
		-DWITH_QHULL=ON \
		-DWITH_QT=OFF \
		-DWITH_VTK=ON \
		-DBUILD_global_tests=ON \
		-DBUILD_examples=OFF \
		-DBUILD_tools=ON \
		-DBUILD_apps=OFF \
		-DBUILD_tests_common=OFF \
		-DBUILD_tests_features=OFF \
		-DBUILD_tests_filters=OFF \
		-DBUILD_tests_io=OFF \
		$disable_segtests \
		-DBUILD_tests_registration=OFF \
		-DGTEST_INCLUDE_DIR=/usr/include/gtest \
		-DGTEST_SRC_DIR=/usr/src/gtest
	make
}

package() {
	cd "$builddir"/build
	make DESTDIR="$pkgdir" install

	install -Dm 0644 "$builddir"/LICENSE.txt "$pkgdir"/usr/share/licenses/$pkgname/LICENSE.txt
}

dev() {
	default_dev

	amove usr/share
}

check() {
	cd "$builddir"/build
	make tests
}

sha512sums="
ca9e742bc24b38f31c42c9ea08e19054e18d045f487269b64a7b831dada89936445d90a5b46870d8c24c2d25b33a59df2d904fe7e51bc0b231317cdb319951e9  pcl-1.15.1.tar.gz
b16eadb7fb2ea1381853597cc7157e5238224fc7f6f367e46ebdc426cef2526d80cd2a6fa9fe30e86d12a488721466c5a15e12a4d8423e7a4210e741a76e4f3f  fix-infinite-loop-in-convex-hull.patch
"
